name: Deploy to Lolipop (SSH Key)
on:
  push:
    branches:
      - main
jobs:
  web-deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
    - name: Get latest code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 2222 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy via Rsync
      run: |
        rsync -avz --delete \
          -e "ssh -p 2222 -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes" \
          --exclude '.git*' \
          --exclude 'node_modules' \
          --exclude '.env*' \
          --exclude '.tools' \
          --exclude '.trae' \
          --exclude '.vercel' \
          --exclude 'supabase' \
          --exclude 'scripts' \
          --exclude 'cms' \
          --exclude 'generate-password.php' \
          --exclude 'MCP-SETUP.md' \
          --exclude 'DEPLOYMENT-GUIDE.md' \
          --exclude 'setup-guide.md' \
          --exclude 'SUPABASE-SETUP-GUIDE.md' \
          --exclude 'package.json' \
          --exclude 'Trend Company.svg' \
          --exclude 'config/supabase.secrets.php' \
          --exclude 'debug-api.php' \
          --exclude 'test-api.php' \
          --exclude 'test-local.html' \
          --exclude 'test-site-settings.html' \
          --exclude 'admin/api/debug-supabase.php' \
          --exclude 'admin/api/test-connection.php' \
          --exclude 'admin/api/test-update.php' \
          --exclude 'admin/tools/reseed.php' \
          --exclude 'seed-supabase.php' \
          --exclude 'server_check.php' \
          ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:web/katayama-website/

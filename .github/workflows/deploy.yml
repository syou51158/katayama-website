name: Deploy to Lolipop (SSH/Rsync)
on:
  push:
    branches:
      - main
jobs:
  web-deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
    - name: Get latest code
      uses: actions/checkout@v4
    
    - name: Install sshpass
      run: sudo apt-get install -y sshpass

    - name: Deploy via Rsync
      env:
        SSH_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      run: |
        # Use sshpass to provide the password non-interactively
        sshpass -p "$SSH_PASSWORD" rsync -avz --delete \
          -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
          --exclude '.git*' \
          --exclude 'node_modules' \
          --exclude '.env*' \
          --exclude '.tools' \
          --exclude '.trae' \
          --exclude '.vercel' \
          --exclude 'supabase' \
          --exclude 'scripts' \
          --exclude 'cms' \
          --exclude 'generate-password.php' \
          --exclude 'MCP-SETUP.md' \
          --exclude 'DEPLOYMENT-GUIDE.md' \
          --exclude 'setup-guide.md' \
          --exclude 'SUPABASE-SETUP-GUIDE.md' \
          --exclude 'package.json' \
          --exclude 'Trend Company.svg' \
          --exclude 'config/supabase.secrets.php' \
          --exclude 'debug-api.php' \
          --exclude 'test-api.php' \
          --exclude 'test-local.html' \
          --exclude 'test-site-settings.html' \
          --exclude 'admin/api/debug-supabase.php' \
          --exclude 'admin/api/test-connection.php' \
          --exclude 'admin/api/test-update.php' \
          --exclude 'admin/tools/reseed.php' \
          --exclude 'seed-supabase.php' \
          --exclude 'server_check.php' \
          ./ ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }}:web/katayama-website/
